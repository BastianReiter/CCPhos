---
title: "Data Selection"
id: chapter-DataSelection
editor: source
---

```{r}
#| label: Setup
#| echo: false

knitr::opts_chunk$set(echo = FALSE)

source("RSetup.R", local = knitr::knit_global())
```

\

### Data Source and Form

The primary data source is a hospital's data base on KHEntgG-§21-data. This data is usually accessible by the hospital's Data Integration Center (DIC). Selected data should be exported to a tabular file format like .csv oder .xlsx in order to be fed into the analysis pipeline provided by the Project Administrator.

### Cohort Selection

In accordance with the [Study Cohort specification](#section-StudyCohort) data of the following cases and their corresponding patients should be selected from a local data base:

-   Date of admission between 01-01-2005 and 12-31-2022
-   Age at date of admission at least 18 years
-   Select all cases of patients with one of the following ICD-10 codes documented in their case data:

```{r}
#| label: ICD10Codes

read_excel(path = "./files/Tables.xlsx", sheet = "ICD-10-Codes") %>%
    gt(groupname_col = "Category") %>%
    theme_gt_CDSG()
```


### Required Data Elements

Following the syntax and terminology used in the official addendum on data transmission in compliance with §21 KHEntgG (see [Downloads](#chapter-Downloads)), the table below lists the attributes to be included in Data Selection and Export.

```{r}
#| label: DataElements

read_excel(path = "./files/Tables.xlsx", sheet = "DataElements") %>%
    select(Table,
           Attribute_Name,
           Attribute_Description,
           Obligatory,
           Attribute_Data_Type) %>%
    mutate(Table = paste0("Table: ", Table)) %>%
    gt(groupname_col = "Table") %>%
    theme_gt_CDSG()

```


### Mockup SQL Query

A corresponding sequence of mockup SQL queries could look like the following:

```sql

-- Create table *EligibleCases*: All Cases of eligible Patients (Subset of Table *Fall*) --
CREATE TABLE EligibleCases AS
SELECT KH-internes-Kennzeichen,
       Geburtsjahr,
       Geschlecht,
       PLZ,
       Aufnahmedatum,
       Aufnahmeanlass,
       Entlassungsdatum,
       Entlassungsgrund,
       Alter-in-Jahren-am-Aufnahmetag,
       Patientennummer,
       Verweildauer-Intensiv
FROM Fall
WHERE Patientennummer IN
  ( SELECT DISTINCT Patientennummer
      FROM Fall LEFT JOIN ICD ON Fall.KH-internes-Kennzeichen = ICD.KH-internes-Kennzeichen
      WHERE Diagnoseschlüssel LIKE 'C%'
         OR Diagnoseschlüssel LIKE 'D0%'
         OR Diagnoseschlüssel LIKE 'D3[7-9]'
         OR Diagnoseschlüssel LIKE 'D4[0-8]'
         OR Diagnoseschlüssel IN ('Z08', 'Z85', 'Z92.6')
         OR Diagnoseschlüssel IN ('B20', 'B21', 'B22', 'B23.-', 'B23.0', 'B23.8', 'B24', 'Z21', 'O98.7')
         OR Sekundär-Diagnoseschlüssel LIKE 'U60%'
         OR Sekundär-Diagnoseschlüssel LIKE 'U61%'
         OR Sekundär-Diagnoseschlüssel LIKE 'U85%' )


-- Select subset of Table *FAB* for Export --
SELECT FAB.KH-internes-Kennzeichen,
       FAB.Fachabteilung,
       FAB.FAB-Aufnahmedatum,
       FAB.FAB-Entlassungsdatum,
       FAB.KennungIntensivbett
FROM FAB RIGHT JOIN EligibleCaseIDs AS
                    ( SELECT DISTINCT KH-internes-Kennzeichen FROM EligibleCases )
         ON FAB.KH-internes-Kennzeichen = EligibleCaseIDs.KH-internes-Kennzeichen


-- Select subset of Table *ICD* for Export --
SELECT ICD.KH-internes-Kennzeichen,
       ICD.Diagnoseart,
       ICD.ICD-Version,
       ICD.ICD-Kode,
       ICD.Sekundär-Kode
FROM ICD RIGHT JOIN EligibleCaseIDs AS
                    ( SELECT DISTINCT KH-internes-Kennzeichen FROM EligibleCases )
         ON ICD.KH-internes-Kennzeichen = EligibleCaseIDs.KH-internes-Kennzeichen


-- Select subset of Table *OPS* for Export --
SELECT OPS.KH-internes-Kennzeichen,
       OPS.OPS-Version,
       OPS.OPS-Kode,
       OPS.OPS-Datum
FROM OPS RIGHT JOIN EligibleCaseIDs AS
                    ( SELECT DISTINCT KH-internes-Kennzeichen FROM EligibleCases )
         ON OPS.KH-internes-Kennzeichen = EligibleCaseIDs.KH-internes-Kennzeichen


```
